<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Avaliação 360°</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
.container { padding: 20px; border-radius: 10px; background: #f5f5f5; }
input, select, textarea { width: 100%; margin-top: 8px; margin-bottom: 15px; padding: 8px; }
button { padding: 12px; font-size: 16px; cursor: pointer; }
h2 { margin-top: 40px; }
.caixa { padding: 15px; background: white; border-radius: 8px; margin-bottom: 20px; }
</style>
</head>
<body>

<h1>Avaliação 360°</h1>
<p>
Complete sua avaliação seguindo as regras: 
<b>apenas 1 nota 6</b> e <b>no máximo 2 notas 5</b>. 
Você deve avaliar todos os integrantes da sua equipe, inclusive a si mesmo.
</p>

<div class="container">

<form id="form-avaliacao"
      method="POST"
      action="SUA_URL_DO_WEB_APP_AQUI"
      target="hidden_iframe"
      onsubmit="return enviar(event)">

  <label>Seu nome:</label>
  <select id="aluno">
    <option value="">Selecione...</option>

    <optgroup label="EQUIPE 1">
      <option>Ana Clara Pitzer</option>
      <option>Fernanda Weiskopf</option>
      <option>Kaylane Lima</option>
      <option>Julia Matias</option>
      <option>Maria Eduarda Pinheiro</option>
      <option>Maria Eduarda Romeu</option>
    </optgroup>

    <optgroup label="EQUIPE 2">
      <option>Julia Barra</option>
      <option>Juliana Cavalcanti</option>
      <option>Laura Azevedo</option>
      <option>Marina Vidigal</option>
      <option>Sofia Carvalho</option>
    </optgroup>

    <optgroup label="EQUIPE 3">
      <option>Arthur Malta</option>
      <option>Carlos Eduardo Fragozo</option>
      <option>Cezar Augusto Areias</option>
      <option>Felipe Saul</option>
      <option>Eric Grillo</option>
      <option>Gustavo Geller</option>
    </optgroup>

    <optgroup label="EQUIPE 4">
      <option>Beny Steinberg</option>
      <option>Fernando Oliveira</option>
      <option>João Solberg</option>
      <option>Rodrigo Castro</option>
      <option>Pedro Antonio Cafasso</option>
      <option>Pietro Maiolino</option>
    </optgroup>

    <optgroup label="EQUIPE 5">
      <option>Bruno Contanza</option>
      <option>Caio Romero</option>
      <option>Diego Pedrosa</option>
      <option>Enzo Senna</option>
      <option>Ricardo Paciello</option>
    </optgroup>
  </select>

  <h2>Avalie os membros da SUA equipe:</h2>
  <div id="avaliacoes"></div>

  <!-- Campo oculto que leva o JSON para o Apps Script -->
  <input type="hidden" name="data" id="campo-data">

  <button type="submit">Enviar avaliação</button>
  <p id="retorno" style="font-weight:bold; margin-top:20px;"></p>

</form>

</div>

<!-- iframe invisível para não sair da página ao enviar -->
<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
// Mapeamento das equipes
const equipes = {
  1: ["Ana Clara Pitzer","Fernanda Weiskopf","Kaylane Lima","Julia Matias","Maria Eduarda Pinheiro","Maria Eduarda Romeu"],
  2: ["Julia Barra","Juliana Cavalcanti","Laura Azevedo","Marina Vidigal","Sofia Carvalho"],
  3: ["Arthur Malta","Carlos Eduardo Fragozo","Cezar Augusto Areias","Felipe Saul","Eric Grillo","Gustavo Geller"],
  4: ["Beny Steinberg","Fernando Oliveira","João Solberg","Rodrigo Castro","Pedro Antonio Cafasso","Pietro Maiolino"],
  5: ["Bruno Contanza","Caio Romero","Diego Pedrosa","Enzo Senna","Ricardo Paciello"]
};

// Descobre a equipe a partir do nome do aluno
function obterEquipeDoAluno(nomeAluno) {
  for (const key in equipes) {
    if (equipes[key].includes(nomeAluno)) {
      return equipes[key]; // retorna o array com todos os nomes da equipe
    }
  }
  return null;
}

function gerarCampos(){
  const aluno = document.getElementById("aluno").value;
  const box = document.getElementById("avaliacoes");
  box.innerHTML = "";
  if(!aluno) return;

  const equipe = obterEquipeDoAluno(aluno);
  if (!equipe) {
    box.innerHTML = "<p style='color:red;'>Erro: aluno não encontrado em nenhuma equipe.</p>";
    return;
  }

  // Gera campos apenas para os membros da própria equipe, incluindo o próprio aluno
  equipe.forEach(nome => {
    box.innerHTML += `
      <div class="caixa">
        <h3>${nome}</h3>
        <label>Nota (1 a 6):</label>
        <select class="nota" data-nome="${nome}">
          <option value="">Selecione...</option>
          <option>1</option><option>2</option><option>3</option>
          <option>4</option><option>5</option><option>6</option>
        </select>

        <label>Justificativa:</label>
        <textarea class="just" data-nome="${nome}" rows="3"></textarea>
      </div>
    `;
  });
}

document.getElementById("aluno").addEventListener("change", gerarCampos);

function enviar(event){
  event.preventDefault(); // impede o envio automático até montarmos os dados

  const aluno = document.getElementById("aluno").value;
  if (!aluno) {
    alert("Selecione seu nome.");
    return false;
  }

  let avaliacoes = [];
  document.querySelectorAll(".nota").forEach(sel => {
    const nome = sel.getAttribute("data-nome");
    const nota = Number(sel.value);
    const justificativa = document.querySelector(`.just[data-nome="${nome}"]`).value;
    if (nota) {
      avaliacoes.push({ avaliado: nome, nota, justificativa });
    }
  });

  const n6 = avaliacoes.filter(a => a.nota === 6).length;
  const n5 = avaliacoes.filter(a => a.nota === 5).length;

  if (n6 > 1) {
    alert("Você só pode dar UMA nota 6.");
    return false;
  }
  if (n5 > 2) {
    alert("Você só pode dar no máximo DUAS notas 5.");
    return false;
  }

  const payload = {
    nome: aluno,
    avaliacoes: avaliacoes
  };

  // Coloca o JSON no campo oculto e envia o form normalmente
  document.getElementById("campo-data").value = JSON.stringify(payload);

  // Envia o formulário via POST para o Apps Script (sem CORS)
  document.getElementById("form-avaliacao").submit();

  // Feedback ao usuário
  document.getElementById("retorno").textContent = "Avaliação enviada! Você já pode fechar esta página.";
  setTimeout(() => {
    document.getElementById("retorno").textContent = "";
    document.getElementById("form-avaliacao").reset();
    document.getElementById("avaliacoes").innerHTML = "";
  }, 3000);

  return false;
}
</script>

</body>
</html>
