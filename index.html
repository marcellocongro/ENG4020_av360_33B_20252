<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Avaliação 360°</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
.container { padding: 20px; border-radius: 10px; background: #f5f5f5; }
input, select, textarea { width: 100%; margin-top: 8px; margin-bottom: 15px; padding: 8px; }
button { padding: 12px; font-size: 16px; cursor: pointer; }
h2 { margin-top: 30px; }
.caixa { padding: 15px; background: white; border-radius: 8px; margin-bottom: 20px; }
.small { font-size: 0.9em; color: #555; }
</style>
</head>
<body>

<h1>Avaliação 360°</h1>
<p>
Cada estudante deve avaliar <b>todos os integrantes da sua própria equipe</b>, 
<b>incluindo a si mesmo</b>, com notas de 1 a 6 e justificativa.
<br>
Regras: <b>apenas 1 nota 6</b> e <b>no máximo 2 notas 5</b> no total.
</p>

<div class="container">

<form id="form-avaliacao"
      method="POST"
      action="https://script.google.com/macros/s/AKfycbyv5f2DDZZbc9LqWPJdnwQYLezurafPuVq3rnvLLyCx2COkSUxV1LEZQzKdzuk7N12H/exec"
      target="hidden_iframe"
      onsubmit="return enviar(event)">

  <label>Selecione sua equipe:</label>
  <select id="equipe">
    <option value="">Selecione...</option>
    <option value="1">Equipe 1</option>
    <option value="2">Equipe 2</option>
    <option value="3">Equipe 3</option>
    <option value="4">Equipe 4</option>
    <option value="5">Equipe 5</option>
  </select>

  <label>Seu nome:</label>
  <select id="aluno" disabled>
    <option value="">Selecione a equipe primeiro...</option>
  </select>

  <h2>Avalie os membros da SUA equipe:</h2>
  <p class="small">Preencha nota (1 a 6) e justificativa para cada membro, inclusive você.</p>
  <div id="avaliacoes"></div>

  <!-- Campo oculto que leva o JSON para o Apps Script -->
  <input type="hidden" name="data" id="campo-data">

  <button type="submit">Enviar avaliação</button>
  <p id="retorno" style="font-weight:bold; margin-top:20px;"></p>

</form>

</div>

<!-- iframe invisível para não sair da página ao enviar -->
<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
// MAPEAMENTO DAS EQUIPES
const equipes = {
  1: ["Ana Clara Pitzer","Fernanda Weiskopf","Kaylane Lima","Julia Matias","Maria Eduarda Pinheiro","Maria Eduarda Romeu"],
  2: ["Julia Barra","Juliana Cavalcanti","Laura Azevedo","Marina Vidigal","Sofia Carvalho"],
  3: ["Arthur Malta","Carlos Eduardo Fragozo","Cezar Augusto Areias","Felipe Saul","Eric Grillo","Gustavo Geller"],
  4: ["Beny Steinberg","Fernando Oliveira","João Solberg","Rodrigo Castro","Pedro Antonio Cafasso","Pietro Maiolino"],
  5: ["Bruno Contanza","Caio Romero","Diego Pedrosa","Enzo Senna","Ricardo Paciello"]
};

// Quando selecionar equipe, preencher dropdown de aluno com nomes daquela equipe
document.getElementById("equipe").addEventListener("change", function() {
  const equipeSelecionada = this.value;
  const alunoSelect = document.getElementById("aluno");
  const avaliacaoDiv = document.getElementById("avaliacoes");

  alunoSelect.innerHTML = "";
  avaliacaoDiv.innerHTML = "";

  if (!equipeSelecionada) {
    alunoSelect.disabled = true;
    alunoSelect.innerHTML = '<option value="">Selecione a equipe primeiro...</option>';
    return;
  }

  const membros = equipes[equipeSelecionada];
  alunoSelect.disabled = false;
  alunoSelect.innerHTML = '<option value="">Selecione seu nome...</option>';

  membros.forEach(nome => {
    const opt = document.createElement("option");
    opt.value = nome;
    opt.textContent = nome;
    alunoSelect.appendChild(opt);
  });
});

// Quando selecionar o aluno, gerar campos de avaliação apenas para a equipe dele (inclusive ele mesmo)
document.getElementById("aluno").addEventListener("change", function() {
  const equipeSelecionada = document.getElementById("equipe").value;
  const aluno = this.value;
  const avaliacaoDiv = document.getElementById("avaliacoes");
  avaliacaoDiv.innerHTML = "";

  if (!equipeSelecionada || !aluno) return;

  const membros = equipes[equipeSelecionada];

  membros.forEach(nome => {
    avaliacaoDiv.innerHTML += `
      <div class="caixa">
        <h3>${nome}</h3>
        <label>Nota (1 a 6):</label>
        <select class="nota" data-nome="${nome}">
          <option value="">Selecione...</option>
          <option>1</option><option>2</option><option>3</option>
          <option>4</option><option>5</option><option>6</option>
        </select>

        <label>Justificativa:</label>
        <textarea class="just" data-nome="${nome}" rows="3"></textarea>
      </div>
    `;
  });
});

function enviar(event){
  event.preventDefault(); // impede o envio automático até montarmos os dados

  const equipe = document.getElementById("equipe").value;
  const aluno = document.getElementById("aluno").value;
  const retorno = document.getElementById("retorno");

  if (!equipe) {
    alert("Selecione sua equipe.");
    return false;
  }
  if (!aluno) {
    alert("Selecione seu nome.");
    return false;
  }

  let avaliacoes = [];
  document.querySelectorAll(".nota").forEach(sel => {
    const nome = sel.getAttribute("data-nome");
    const nota = Number(sel.value);
    const justificativa = document.querySelector(`.just[data-nome="${nome}"]`).value;
    if (nota) {
      avaliacoes.push({ avaliado: nome, nota, justificativa });
    }
  });

  // Regras de notas
  const n6 = avaliacoes.filter(a => a.nota === 6).length;
  const n5 = avaliacoes.filter(a => a.nota === 5).length;

  if (n6 > 1) {
    alert("Você só pode dar UMA nota 6.");
    return false;
  }
  if (n5 > 2) {
    alert("Você só pode dar no máximo DUAS notas 5.");
    return false;
  }

  const payload = {
    nome: aluno,
    equipe: equipe,
    avaliacoes: avaliacoes
  };

  // Coloca o JSON no campo oculto e envia o form normalmente (sem CORS)
  document.getElementById("campo-data").value = JSON.stringify(payload);
  document.getElementById("form-avaliacao").submit();

  retorno.textContent = "Avaliação enviada! Você já pode fechar esta página.";
  setTimeout(() => {
    retorno.textContent = "";
    document.getElementById("form-avaliacao").reset();
    document.getElementById("avaliacoes").innerHTML = "";
  }, 3000);

  return false;
}
</script>

</body>
</html>
